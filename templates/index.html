<!DOCTYPE html>
<html>
<head>
    <title>Water Tank Control System</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .tank-card {
            margin: 10px;
            padding: 15px;
        }
        .pump-status {
            font-weight: bold;
        }
        .mode-button {
            margin: 5px;
        }
        .active-mode {
            border: 2px solid #28a745;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="text-center mb-4">Water Tank Control System</h1>

        <!-- Mode Selection -->
        <div class="card mb-4">
            <div class="card-header">
                <h4>Operation Mode: <span id="current-mode">{{ current_mode }}</span></h4>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-center">
                    {% for mode_key, mode_name in available_modes.items() %}
                    <button class="btn btn-outline-primary mode-button {% if mode_key == current_mode %}active-mode{% endif %}"
                            onclick="changeMode('{{ mode_key }}')">
                        {{ mode_name }}
                    </button>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Summer Tank Card -->
            <div class="col-md-6">
                <div class="card tank-card">
                    <div class="card-header">
                        <h4>Summer Tank</h4>
                    </div>
                    <div class="card-body">
                        <p>State: <span id="summer-state">{{ summer_tank_state }}</span></p>
                        <div id="summer-stats"></div>
                    </div>
                </div>
            </div>

            <!-- Winter Tank Card -->
            <div class="col-md-6">
                <div class="card tank-card">
                    <div class="card-header">
                        <h4>Winter Tank</h4>
                    </div>
                    <div class="card-body">
                        <p>State: <span id="winter-state">{{ winter_tank_state }}</span></p>
                        <div id="winter-stats"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pump Status Card -->
        <div class="card mt-4">
            <div class="card-header">
                <h4>Pump Status</h4>
            </div>
            <div class="card-body">
                <p>Well Pump: <span id="well-pump-status" class="pump-status">{{ well_pump_status }}</span></p>
                <p>Distribution Pump: <span id="dist-pump-status" class="pump-status">{{ dist_pump_status }}</span></p>
            </div>
        </div>

        <!-- GPIO Debug Card -->
        <div class="card mt-4">
            <div class="card-header">
                <h4>GPIO Debug States</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <h5>Summer Tank Sensors</h5>
                        <div id="summer-gpio-states"></div>
                    </div>
                    <div class="col-md-4">
                        <h5>Winter Tank Sensors</h5>
                        <div id="winter-gpio-states"></div>
                    </div>
                    <div class="col-md-4">
                        <h5>Pump States</h5>
                        <div id="pump-gpio-states"></div>
                    </div>
                    <div class="col-md-12 mt-3">
                        <h5>Thread Status</h5>
                        <div id="thread-status"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mode Change Confirmation Modal -->
    <div class="modal fade" id="modeConfirmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Mode Change</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="mode-change-message"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirm-mode-change">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let pendingMode = null;
        const modeConfirmModal = new bootstrap.Modal(document.getElementById('modeConfirmModal'));

        function updateState() {
            fetch('/api/state')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('current-mode').textContent = data.current_mode;
                    document.getElementById('summer-state').textContent = data.summer_tank.state;
                    document.getElementById('winter-state').textContent = data.winter_tank.state;
                    document.getElementById('well-pump-status').textContent = data.well_pump_status;
                    document.getElementById('dist-pump-status').textContent = data.dist_pump_status;

                    // Update stats
                    document.getElementById('summer-stats').innerHTML = formatStats(data.summer_tank.stats);
                    document.getElementById('winter-stats').innerHTML = formatStats(data.winter_tank.stats);
                });
        }

        function formatStats(stats) {
            return `
                <p>Today: ${stats.today_runtime} (${stats.today_gallons} gallons)</p>
                <p>Week: ${stats.week_runtime} (${stats.week_gallons} gallons)</p>
                <p>Month: ${stats.month_runtime} (${stats.month_gallons} gallons)</p>
            `;
        }

        function changeMode(mode) {
            fetch('/api/mode', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ mode: mode, confirm: false })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'confirmation_required') {
                    pendingMode = mode;
                    document.getElementById('mode-change-message').textContent = data.message;
                    modeConfirmModal.show();
                }
            });
        }

        document.getElementById('confirm-mode-change').addEventListener('click', function() {
            if (pendingMode) {
                fetch('/api/mode', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ mode: pendingMode, confirm: true })
                })
                .then(response => response.json())
                .then(data => {
                    modeConfirmModal.hide();
                    pendingMode = null;
                    updateState();
                });
            }
        });

        // Update state every second
        setInterval(updateState, 1000);
    </script>
<!-- Add this to your existing script section -->
<script>
    function updateGPIOStates() {
        fetch('/api/gpio_states')
            .then(response => response.json())
            .then(data => {
                // Update Summer Tank States
                let summerHtml = `
                    <p>High (Pin ${data.summer_tank.high.pin}): 
                        Raw: ${data.summer_tank.high.raw_value} 
                        Inverted: ${data.summer_tank.high.inverted_value}</p>
                    <p>Low (Pin ${data.summer_tank.low.pin}): 
                        Raw: ${data.summer_tank.low.raw_value} 
                        Inverted: ${data.summer_tank.low.inverted_value}</p>
                    <p>Empty (Pin ${data.summer_tank.empty.pin}): 
                        Raw: ${data.summer_tank.empty.raw_value} 
                        Inverted: ${data.summer_tank.empty.inverted_value}</p>
                `;
                document.getElementById('summer-gpio-states').innerHTML = summerHtml;

                // Update Winter Tank States
                let winterHtml = `
                    <p>High (Pin ${data.winter_tank.high.pin}): 
                        Raw: ${data.winter_tank.high.raw_value} 
                        Inverted: ${data.winter_tank.high.inverted_value}</p>
                    <p>Low (Pin ${data.winter_tank.low.pin}): 
                        Raw: ${data.winter_tank.low.raw_value} 
                        Inverted: ${data.winter_tank.low.inverted_value}</p>
                `;
                document.getElementById('winter-gpio-states').innerHTML = winterHtml;

                // Update Pump States
                let pumpHtml = `
                    <p>Well Pump (Pin ${data.pumps.well.pin}): 
                        ${data.pumps.well.value}</p>
                    <p>Distribution Pump (Pin ${data.pumps.distribution.pin}): 
                        ${data.pumps.distribution.value}</p>
                `;
                document.getElementById('pump-gpio-states').innerHTML = pumpHtml;
            });
        // Add this to your updateGPIOStates function
        fetch('/api/thread_status')
            .then(response => response.json())
            .then(data => {
                let statusHtml = `
                    <p>Control Thread Running: <strong>${data.thread_running}</strong></p>
                    <p>Last Check: ${data.last_update}</p>
                `;
                document.getElementById('thread-status').innerHTML = statusHtml;
            });
    }

    // Add this to your existing setInterval calls
    setInterval(updateGPIOStates, 1000);
</script>
</body>
</html>