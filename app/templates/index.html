<!DOCTYPE html>
<html>

<head>
    <title>Water Tank Control System</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="{{ url_for('static', filename='css/main.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/components/tanks.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/components/pumps.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/components/modes.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/components/gpio.css') }}" rel="stylesheet">
</head>

<body>
    <div class="container mt-4">
        <h1 class="text-center mb-4">Water Tank Control System</h1>

        <!-- Mode Selection -->
        <div class="card mb-4">
            <div class="card-header">
                <h4>Operation Mode: <span id="current-mode">{{ current_mode }}</span></h4>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-center">
                    {% for mode_key, mode_name in available_modes.items() %}
                    <button class="btn btn-outline-primary mode-button {% if mode_key == current_mode %}active-mode{% endif %}"
                        data-mode="{{ mode_key }}">
                        {{ mode_name }}
                    </button>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- First, modify the tank cards to be hideable -->
        <div class="row">
            <!-- Summer Tank Card -->
            <div class="col-md-6" id="summer-tank-section">
                <div class="card tank-card">
                    <div class="card-header">
                        <h4>Summer Tank</h4>
                    </div>
                    <div class="card-body">
                        <p>State: <span id="summer-state">{{ summer_tank_state }}</span></p>
                        <div id="summer-stats"></div>
                    </div>
                </div>
            </div>

            <!-- Winter Tank Card -->
            <div class="col-md-6" id="winter-tank-section">
                <div class="card tank-card">
                    <div class="card-header">
                        <h4>Winter Tank</h4>
                    </div>
                    <div class="card-body">
                        <p>State: <span id="winter-state">{{ winter_tank_state }}</span></p>
                        <div id="winter-stats"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Changeover Mode Manual Control -->
        <div class="card mt-4" id="changeover-controls" style="display: none;">
            <div class="card-header">
                <h4>Changeover Mode - Well Pump Manual Control</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-12">
                        <p class="text-info mb-3">
                            <i class="bi bi-info-circle"></i>
                            This control allows manual operation of the well pump during changeover mode.
                        </p>
                        <button id="manual-pump-toggle" class="btn btn-primary pump-control-button">
                            Start Well Pump
                        </button>
                        <p class="mt-2">Well Pump Manual Control Status: <span id="manual-pump-status"
                                class="fw-bold">OFF</span></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pump Status Card -->
        <div class="card mt-4">
            <div class="card-header">
                <h4>Pump Status</h4>
            </div>
            <div class="card-body">
                <p>Well Pump: <span id="well-pump-status" class="pump-status">{{ well_pump_status }}</span></p>
                <img id="well-pump-image" src="{{ url_for('static', filename='img/pump_off.jpg') }}"
                    alt="Well Pump Status" class="img-fluid pump-status-image">
                <p>Distribution Pump: <span id="dist-pump-status" class="pump-status">{{ dist_pump_status }}</span></p>
            </div>
        </div>

        <!-- GPIO Debug Card -->
        <div class="card mt-4">
            <div class="card-header">
                <h4>GPIO Debug States</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <h5>Summer Tank Sensors</h5>
                        <div id="summer-gpio-states" class="gpio-states">
                            <!-- content -->
                        </div>
                    </div>
                    <div class="col-md-4">
                        <h5>Winter Tank Sensors</h5>
                        <div id="winter-gpio-states"></div>
                    </div>
                    <div class="col-md-4">
                        <h5>Pump States</h5>
                        <div id="pump-gpio-states"></div>
                    </div>
                    <div class="col-md-12 mt-3">
                        <h5>Thread Status</h5>
                        <div id="thread-status"></div>
                    </div>
                    <!-- Add this inside the GPIO Debug Card, after the Thread Status section -->
                    <div class="col-md-12 mt-3">
                        <h5>Mode Debug</h5>
                        <div id="mode-debug">
                            <p>Current Mode: <span id="debug-current-mode"></span></p>
                            <p>Last Mode Change: <span id="debug-last-mode-change"></span></p>
                            <p>Last Mode Change Status: <span id="debug-mode-change-status"></span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mode Change Confirmation Modal -->
    <div class="modal fade" id="modeConfirmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Mode Change</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="mode-change-message"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirm-mode-change">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Keep the Bootstrap script -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Add the new modular main script -->
    <script type="module" src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>

</html>